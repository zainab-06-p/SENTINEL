<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACIR Platform â€” Task 1: Data Ingestion Dashboard</title>
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0a0e1a;
      --panel:     #111827;
      --border:    #1f2d3d;
      --accent:    #00d4ff;
      --accent2:   #7c3aed;
      --red:       #ef4444;
      --yellow:    #f59e0b;
      --green:     #10b981;
      --text:      #e2e8f0;
      --muted:     #64748b;
      --font:      'Segoe UI', system-ui, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: linear-gradient(90deg, #0f172a 0%, #1e1b4b 100%);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
    }
    .logo h1 { font-size: 18px; font-weight: 700; }
    .logo p  { font-size: 11px; color: var(--muted); }
    .header-status { display: flex; align-items: center; gap: 20px; }
    .status-badge {
      display: flex; align-items: center; gap: 6px;
      font-size: 12px; padding: 4px 12px;
      border-radius: 20px; border: 1px solid;
    }
    .status-badge.online  { border-color: var(--green); color: var(--green); }
    .status-badge.offline { border-color: var(--red);   color: var(--red);   }
    .status-badge.checking{ border-color: var(--yellow);color: var(--yellow);}
    .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .dot.pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container { max-width: 1400px; margin: 0 auto; padding: 24px 32px; }

    /* â”€â”€ Stat cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .stat-card .label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
    .stat-card .value { font-size: 32px; font-weight: 700; margin: 6px 0 2px; }
    .stat-card .sub   { font-size: 12px; color: var(--muted); }
    .stat-card.accent .value { color: var(--accent); }
    .stat-card.red    .value { color: var(--red); }
    .stat-card.green  .value { color: var(--green); }
    .stat-card.yellow .value { color: var(--yellow); }

    /* â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .grid-1 { margin-bottom: 20px; }
    @media(max-width:900px) { .grid-2 { grid-template-columns: 1fr; } }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .panel-header h2 { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .panel-body { padding: 20px; }

    /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
    .field input[type=range] { width: 160px; accent-color: var(--accent); }
    .field span { font-size: 13px; color: var(--accent); font-weight: 600; }
    .field input[type=number] {
      background: var(--bg); border: 1px solid var(--border);
      color: var(--text); padding: 8px 12px; border-radius: 8px;
      font-size: 14px; width: 100px;
    }

    button {
      padding: 10px 20px; border-radius: 8px; border: none;
      font-size: 13px; font-weight: 600; cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
    }
    button:hover  { opacity: 0.85; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .btn-primary { background: linear-gradient(90deg, var(--accent), #0080a0); color: #000; }
    .btn-danger  { background: var(--red);   color: #fff; }
    .btn-ghost   { background: var(--border); color: var(--text); }

    /* â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .progress-bar-wrap {
      height: 4px; background: var(--border);
      border-radius: 2px; overflow: hidden; margin-top: 12px;
    }
    .progress-bar {
      height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 2px; transition: width 0.3s;
      width: 0%;
    }

    /* â”€â”€ Alert table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th {
      text-align: left; padding: 10px 14px;
      font-size: 11px; text-transform: uppercase;
      letter-spacing: 1px; color: var(--muted);
      border-bottom: 1px solid var(--border);
    }
    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
    }
    tbody tr:hover  { background: rgba(255,255,255,0.03); }
    tbody tr:last-child { border-bottom: none; }
    td { padding: 10px 14px; vertical-align: top; }

    .risk-bar-cell { min-width: 120px; }
    .risk-bar-bg   { background: var(--border); border-radius: 4px; height: 6px; overflow: hidden; }
    .risk-bar-fill { height: 100%; border-radius: 4px; }

    .badge {
      display: inline-block; padding: 2px 8px; border-radius: 10px;
      font-size: 11px; font-weight: 600; text-transform: uppercase;
    }
    .badge-red    { background: rgba(239,68,68,0.15);  color: var(--red);    }
    .badge-yellow { background: rgba(245,158,11,0.15); color: var(--yellow); }
    .badge-green  { background: rgba(16,185,129,0.15); color: var(--green);  }
    .badge-blue   { background: rgba(0,212,255,0.12);  color: var(--accent); }

    .mono { font-family: 'Courier New', monospace; font-size: 12px; }
    .truncate { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* â”€â”€ PII scrubber â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .scrub-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media(max-width:700px) { .scrub-row { grid-template-columns: 1fr; } }
    .scrub-box {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px; font-size: 13px;
      line-height: 1.5; min-height: 80px;
    }
    textarea.scrub-box {
      width: 100%; resize: vertical; color: var(--text);
      font-family: var(--font);
    }
    .redacted-token { color: var(--red); font-weight: 600; }

    /* â”€â”€ Feature card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .feature-card {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 10px; padding: 14px;
    }
    .feature-card .f-label { font-size: 11px; color: var(--muted); }
    .feature-card .f-value { font-size: 20px; font-weight: 700; margin-top: 4px; }

    /* â”€â”€ Log stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .log-stream {
      height: 240px; overflow-y: auto;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px;
      font-family: 'Courier New', monospace; font-size: 12px;
      line-height: 1.6;
    }
    .log-stream .entry    { color: var(--muted); }
    .log-stream .entry.info { color: #94a3b8; }
    .log-stream .entry.warn { color: var(--yellow); }
    .log-stream .entry.crit { color: var(--red); }
    .log-stream .entry.ok   { color: var(--green); }

    /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .empty {
      text-align: center; padding: 40px;
      color: var(--muted); font-size: 14px;
    }
    .empty span { display: block; font-size: 32px; margin-bottom: 8px; }

    /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .tabs { display: flex; gap: 4px; padding: 4px; background: var(--bg); border-radius: 8px; }
    .tab {
      flex: 1; padding: 7px 14px; border-radius: 6px;
      font-size: 12px; font-weight: 600; cursor: pointer;
      border: none; background: transparent; color: var(--muted);
      transition: all 0.15s;
    }
    .tab.active { background: var(--panel); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,.4); }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    .spinner {
      display: inline-block; width: 14px; height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  */
    #toast {
      position: fixed; bottom: 24px; right: 24px;
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 20px;
      font-size: 13px; box-shadow: 0 8px 24px rgba(0,0,0,.4);
      transform: translateY(80px); opacity: 0;
      transition: all 0.25s; z-index: 999;
    }
    #toast.show { transform: translateY(0); opacity: 1; }
  </style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header>
  <div class="logo">
    <div class="logo-icon">ğŸ›¡</div>
    <div>
      <h1>ACIR Platform</h1>
      <p>Task 1 â€” Data Ingestion & Anomaly Detection</p>
    </div>
  </div>
  <div class="header-status">
    <div id="api-badge"  class="status-badge checking"><div class="dot pulse"></div> API</div>
    <div id="es-badge"   class="status-badge checking"><div class="dot pulse"></div> Elasticsearch</div>
    <div id="scrub-badge"class="status-badge checking"><div class="dot pulse"></div> PII Scrubber</div>
  </div>
</header>

<!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="container">

  <!-- Stats row -->
  <div class="stats-grid">
    <div class="stat-card accent">
      <div class="label">Logs Generated</div>
      <div class="value" id="stat-logs">â€”</div>
      <div class="sub">This session</div>
    </div>
    <div class="stat-card red">
      <div class="label">Anomalies Detected</div>
      <div class="value" id="stat-anomalies">â€”</div>
      <div class="sub">Above risk threshold</div>
    </div>
    <div class="stat-card yellow">
      <div class="label">Alerts Raised</div>
      <div class="value" id="stat-alerts">â€”</div>
      <div class="sub">Passed to AI Agent</div>
    </div>
    <div class="stat-card green">
      <div class="label">Risk Threshold</div>
      <div class="value" id="stat-threshold">â€”</div>
      <div class="sub">PyOD score cutoff</div>
    </div>
  </div>

  <!-- Controls -->
  <div class="panel grid-1">
    <div class="panel-header">
      <h2>âš™ Pipeline Controls</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="es-mode-label" style="font-size:12px;color:var(--muted)">Mode: checkingâ€¦</span>
      </div>
    </div>
    <div class="panel-body">
      <div class="controls">
        <div class="field">
          <label>Total Logs</label>
          <input type="number" id="ctrl-logs" value="300" min="50" max="2000" step="50" />
        </div>
        <div class="field">
          <label>Attack Fraction: <span id="atk-label">8%</span></label>
          <input type="range" id="ctrl-attack" min="0" max="50" value="8" step="1"
                 oninput="document.getElementById('atk-label').textContent=this.value+'%'" />
        </div>
        <button class="btn-primary" id="btn-run" onclick="runPipeline()">
          â–¶ Run Pipeline
        </button>
        <button class="btn-ghost" onclick="resetIndices()">ğŸ—‘ Reset Indices</button>
        <button class="btn-ghost" onclick="loadStatus()">â†º Refresh Status</button>
      </div>
      <div class="progress-bar-wrap" id="progress-wrap" style="display:none">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
    </div>
  </div>

  <!-- Alerts + Features -->
  <div class="grid-2">

    <!-- Alert feed -->
    <div class="panel">
      <div class="panel-header">
        <h2>ğŸš¨ High-Priority Alerts</h2>
        <span id="alert-count" style="font-size:12px;color:var(--muted)">0 alerts</span>
      </div>
      <div class="panel-body">
        <div class="table-wrap" id="alert-table-wrap">
          <div class="empty"><span>ğŸ”</span>Run the pipeline to generate alerts</div>
        </div>
      </div>
    </div>

    <!-- Activity log -->
    <div class="panel">
      <div class="panel-header">
        <h2>ğŸ“‹ Pipeline Activity Log</h2>
        <button class="btn-ghost" style="font-size:11px;padding:4px 10px"
                onclick="clearLog()">Clear</button>
      </div>
      <div class="panel-body">
        <div class="log-stream" id="log-stream">
          <div class="entry ok">[ System ] ACIR Task 1 Dashboard loaded.</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Selected alert features -->
  <div class="panel grid-1" id="features-panel" style="display:none">
    <div class="panel-header">
      <h2>ğŸ“Š Alert Features â€” <span id="features-ip" style="color:var(--accent)"></span></h2>
      <button class="btn-ghost" style="font-size:11px;padding:4px 10px"
              onclick="document.getElementById('features-panel').style.display='none'">âœ• Close</button>
    </div>
    <div class="panel-body">
      <div class="features-grid" id="features-grid"></div>
    </div>
  </div>

  <!-- PII Scrubber -->
  <div class="panel grid-1">
    <div class="panel-header">
      <h2>ğŸ”’ PII Scrubber â€” Live Demo</h2>
      <span id="scrubber-backend-label" style="font-size:12px;color:var(--muted)">Loadingâ€¦</span>
    </div>
    <div class="panel-body">
      <div class="scrub-row">
        <div class="field" style="gap:8px">
          <label>Input (raw log â€” may contain PII)</label>
          <textarea class="scrub-box" id="scrub-input" rows="5"
            placeholder="Type or paste a log line with PII...
&#10;Example: User john@barclays.com (card: 4532015112830366) transferred GB29NWBK60161331926819 to 185.220.101.5"
          ></textarea>
          <div style="display:flex;gap:8px">
            <button class="btn-primary" onclick="runScrub()">ğŸ”’ Scrub PII</button>
            <button class="btn-ghost"   onclick="loadScrubSamples()">Load Samples</button>
          </div>
        </div>
        <div class="field" style="gap:8px">
          <label>Output (PII redacted)</label>
          <div class="scrub-box" id="scrub-output" style="min-height:120px">â€”</div>
        </div>
      </div>

      <!-- Samples -->
      <div id="scrub-samples" style="margin-top:16px;display:none">
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">
          Built-in Samples
        </div>
        <div id="scrub-samples-list"></div>
      </div>
    </div>
  </div>

</div><!-- /container -->

<div id="toast"></div>

<script>
  const API = 'http://localhost:8001';
  let lastAlerts = [];

  // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function toast(msg, color='var(--accent)') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.borderColor = color;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
  }

  function log(msg, type='info') {
    const el = document.getElementById('log-stream');
    const now = new Date().toTimeString().slice(0,8);
    const div = document.createElement('div');
    div.className = `entry ${type}`;
    div.textContent = `[ ${now} ] ${msg}`;
    el.appendChild(div);
    el.scrollTop = el.scrollHeight;
  }

  function clearLog() {
    document.getElementById('log-stream').innerHTML =
      '<div class="entry ok">[ Log cleared ]</div>';
  }

  function riskColor(score) {
    if (score >= 0.85) return 'var(--red)';
    if (score >= 0.65) return 'var(--yellow)';
    return 'var(--green)';
  }

  function severityBadge(sev) {
    const m = { CRITICAL:'badge-red', WARNING:'badge-yellow', INFO:'badge-green' };
    return `<span class="badge ${m[sev]||'badge-blue'}">${sev}</span>`;
  }

  function sourceBadge(src) {
    return `<span class="badge badge-blue">${src}</span>`;
  }

  function highlightRedacted(text) {
    return text.replace(/<([A-Z_]+)>/g,
      '<span class="redacted-token">&lt;$1&gt;</span>');
  }

  function setProgress(pct) {
    document.getElementById('progress-bar').style.width = pct + '%';
  }

  function showProgress() {
    const w = document.getElementById('progress-wrap');
    w.style.display = 'block';
    setProgress(0);
  }

  function hideProgress() {
    setProgress(100);
    setTimeout(() => {
      document.getElementById('progress-wrap').style.display = 'none';
      setProgress(0);
    }, 600);
  }

  // â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function loadStatus() {
    try {
      const res  = await fetch(`${API}/status`);
      const data = await res.json();

      // API badge
      setBadge('api-badge',  true,  'API');
      // ES badge
      setBadge('es-badge',   data.es_reachable, 'Elasticsearch');
      // Scrubber badge
      setBadge('scrub-badge',true, `PII: ${data.scrubber_backend}`);

      // Mode label
      const modeEl = document.getElementById('es-mode-label');
      if (data.es_reachable) {
        modeEl.textContent = `Mode: Full (ES connected) | Logs: ${data.total_raw_logs} | Alerts: ${data.total_alerts}`;
        modeEl.style.color = 'var(--green)';
      } else {
        modeEl.textContent = 'Mode: Offline (Elasticsearch not running â€” using /simulate)';
        modeEl.style.color = 'var(--yellow)';
      }

      // Stats
      document.getElementById('stat-threshold').textContent =
        (data.risk_threshold * 100).toFixed(0) + '%';

      // Scrubber label
      document.getElementById('scrubber-backend-label').textContent =
        `Backend: ${data.scrubber_backend}`;

    } catch(e) {
      setBadge('api-badge',  false, 'API');
      setBadge('es-badge',   false, 'Elasticsearch');
      setBadge('scrub-badge',false, 'PII Scrubber');
      log(`Cannot reach API at ${API} â€” is it running?`, 'crit');
    }
  }

  function setBadge(id, ok, label) {
    const el = document.getElementById(id);
    el.className = `status-badge ${ok ? 'online' : 'offline'}`;
    el.innerHTML = `<div class="dot ${ok ? 'pulse' : ''}"></div> ${label}`;
  }

  // â”€â”€ Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function runPipeline() {
    const numLogs       = parseInt(document.getElementById('ctrl-logs').value);
    const attackPct     = parseInt(document.getElementById('ctrl-attack').value);
    const attackFraction = attackPct / 100;

    const btn = document.getElementById('btn-run');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Runningâ€¦';
    showProgress();

    log(`Starting pipeline: ${numLogs} logs, ${attackPct}% attack fractionâ€¦`);
    setProgress(10);

    try {
      // Try /ingest first (with ES), fall back to /simulate
      let endpoint = '/ingest';
      const statusRes = await fetch(`${API}/status`);
      const status    = await statusRes.json();
      if (!status.es_reachable) {
        endpoint = '/simulate';
        log('Elasticsearch offline â€” using offline simulation mode.', 'warn');
      }

      setProgress(30);
      log('Sending logs to anomaly engineâ€¦');

      const res  = await fetch(`${API}${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ num_logs: numLogs, attack_fraction: attackFraction }),
      });

      setProgress(80);

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || res.statusText);
      }

      const data = await res.json();
      setProgress(100);

      // Update stats
      document.getElementById('stat-logs').textContent      = data.total_logs_generated.toLocaleString();
      document.getElementById('stat-anomalies').textContent = data.anomalies_detected.toLocaleString();
      document.getElementById('stat-alerts').textContent    = data.alerts_raised.toLocaleString();

      log(`âœ“ Pipeline complete â€” ${data.alerts_raised} alerts raised.`, 'ok');
      log(`  Logs: ${data.total_logs_generated} | Anomalies: ${data.anomalies_detected} | Indexed: ${data.total_logs_indexed || 'N/A (offline)'}`, 'ok');

      lastAlerts = data.alerts || [];
      renderAlertTable(lastAlerts);
      toast(`âœ“ ${data.alerts_raised} alerts generated`, 'var(--green)');

    } catch(e) {
      log(`âœ— Pipeline error: ${e.message}`, 'crit');
      toast(`Error: ${e.message}`, 'var(--red)');
    } finally {
      hideProgress();
      btn.disabled = false;
      btn.innerHTML = 'â–¶ Run Pipeline';
    }
  }

  // â”€â”€ Alert table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderAlertTable(alerts) {
    const wrap = document.getElementById('alert-table-wrap');
    document.getElementById('alert-count').textContent = `${alerts.length} alerts`;

    if (!alerts.length) {
      wrap.innerHTML = '<div class="empty"><span>âœ…</span>No alerts detected in this batch</div>';
      return;
    }

    const rows = alerts.map((a, i) => {
      const pct   = (a.risk_score * 100).toFixed(1);
      const color = riskColor(a.risk_score);
      const short = a.scrubbed_payload.length > 60
        ? a.scrubbed_payload.slice(0, 60) + 'â€¦'
        : a.scrubbed_payload;

      return `
        <tr onclick="showFeatures(${i})" style="cursor:pointer">
          <td><span class="mono" style="color:var(--accent)">${a.source_ip}</span></td>
          <td><span class="badge badge-blue">${a.event_type}</span></td>
          <td class="risk-bar-cell">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="font-weight:700;color:${color};width:36px">${pct}%</div>
              <div class="risk-bar-bg" style="flex:1">
                <div class="risk-bar-fill" style="width:${pct}%;background:${color}"></div>
              </div>
            </div>
          </td>
          <td>${severityBadge(a.severity)}</td>
          <td class="truncate mono" style="color:var(--muted);font-size:11px">${short}</td>
          <td style="color:var(--muted);font-size:11px">${new Date(a.timestamp).toLocaleTimeString()}</td>
        </tr>`;
    }).join('');

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Source IP</th>
            <th>Event Type</th>
            <th>Risk Score</th>
            <th>Severity</th>
            <th>Scrubbed Payload</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  // â”€â”€ Feature detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function showFeatures(idx) {
    const alert = lastAlerts[idx];
    if (!alert || !alert.features) return;

    const f    = alert.features;
    const panel = document.getElementById('features-panel');
    panel.style.display = 'block';
    document.getElementById('features-ip').textContent = alert.source_ip;

    const items = [
      { label: 'Event Count',         value: f.event_count,
        color: f.event_count > 200 ? 'var(--red)' : 'var(--text)' },
      { label: 'Unique Dest IPs',     value: f.unique_dest_ips,
        color: f.unique_dest_ips > 10 ? 'var(--yellow)' : 'var(--text)' },
      { label: 'Login Failure Rate',  value: (f.login_failure_rate * 100).toFixed(1) + '%',
        color: f.login_failure_rate > 0.5 ? 'var(--red)' : 'var(--text)' },
      { label: 'DB Query Rate / min', value: f.query_rate_per_min.toFixed(1),
        color: f.query_rate_per_min > 50 ? 'var(--red)' : 'var(--text)' },
      { label: 'Inter-Event Mean ms', value: f.inter_event_mean_ms.toFixed(0) + 'ms',
        color: 'var(--text)' },
      { label: 'Inter-Event Std ms',  value: f.inter_event_std_ms.toFixed(0) + 'ms',
        color: 'var(--text)' },
      { label: 'Session Entropy',     value: f.session_entropy.toFixed(3),
        color: f.session_entropy < 0.5 ? 'var(--red)' : 'var(--text)' },
      { label: 'Off-Hours Ratio',     value: (f.off_hours_ratio * 100).toFixed(1) + '%',
        color: f.off_hours_ratio > 0.7 ? 'var(--red)' : 'var(--text)' },
    ];

    document.getElementById('features-grid').innerHTML = items.map(it => `
      <div class="feature-card">
        <div class="f-label">${it.label}</div>
        <div class="f-value" style="color:${it.color}">${it.value}</div>
      </div>
    `).join('');

    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    log(`Showing features for ${alert.source_ip} (risk=${(alert.risk_score*100).toFixed(1)}%)`);
  }

  // â”€â”€ PII Scrubber â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function runScrub() {
    const text = document.getElementById('scrub-input').value.trim();
    if (!text) { toast('Enter text to scrub', 'var(--yellow)'); return; }

    try {
      const res  = await fetch(`${API}/scrubber/demo`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
      });
      const data = await res.json();
      document.getElementById('scrub-output').innerHTML = highlightRedacted(data.scrubbed);
      log(`PII scrubbed via ${data.backend}`, 'ok');
    } catch(e) {
      document.getElementById('scrub-output').textContent = 'Error: ' + e.message;
    }
  }

  async function loadScrubSamples() {
    const wrap = document.getElementById('scrub-samples');
    const list = document.getElementById('scrub-samples-list');
    try {
      const res  = await fetch(`${API}/scrubber/demo`);
      const data = await res.json();
      list.innerHTML = data.examples.map(ex => `
        <div style="margin-bottom:14px;border:1px solid var(--border);border-radius:8px;overflow:hidden">
          <div style="padding:8px 12px;background:var(--bg);font-size:11px;color:var(--muted)">
            ORIGINAL
          </div>
          <div style="padding:8px 12px;font-size:12px;font-family:monospace">${ex.original}</div>
          <div style="padding:8px 12px;background:var(--bg);font-size:11px;color:var(--muted)">
            SCRUBBED
          </div>
          <div style="padding:8px 12px;font-size:12px;font-family:monospace">
            ${highlightRedacted(ex.scrubbed)}
          </div>
        </div>
      `).join('');
      wrap.style.display = 'block';
    } catch(e) {
      log('Could not load scrubber samples: ' + e.message, 'crit');
    }
  }

  // â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function resetIndices() {
    if (!confirm('This will delete ALL indexed logs and alerts. Continue?')) return;
    try {
      const res  = await fetch(`${API}/reset`, { method: 'POST' });
      const data = await res.json();
      log('Elasticsearch indices reset.', 'warn');
      toast('Indices reset', 'var(--yellow)');
      loadStatus();
    } catch(e) {
      log('Reset failed: ' + e.message, 'crit');
    }
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  (async function init() {
    await loadStatus();
    log('Dashboard ready. Configure the controls and click Run Pipeline.');
  })();
</script>
</body>
</html>
